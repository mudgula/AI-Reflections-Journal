# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Common Development Commands

- **Create and activate a virtual environment**
  ```bash
  python -m venv venv
  source venv/bin/activate   # macOS/Linux
  # .\venv\Scripts\activate  # Windows
  ```

- **Install project dependencies**
  ```bash
  pip install -r requirements.txt
  ```

- **Initialize / migrate the SQLite database** (creates schema or applies missing columns)
  ```bash
  python initialize_db.py
  # If you need to force a migration without re‑initialising:
  python migrate_db.py
  ```

- **Run the Streamlit application**
  ```bash
  streamlit run app.py
  ```

- **Run the test suite** (if a `tests/` directory is present)
  ```bash
  python -m pytest tests/
  ```

- **Run a single test**
  ```bash
  python -m pytest tests/<test_file>.py::test_name
  ```

- **Lint the code (optional)**
  ```bash
  flake8 .
  ```

## High‑Level Architecture

- **`app.py`** – Streamlit entry point. Sets up the UI, navigation, and session state, then delegates to three main pages:
  - *New Entry* – collects mood, factors, text; calls `AIService.analyze_entry` and stores the entry via `ReflectionDB`.
  - *Past Entries* – displays stored entries, AI insights, weather data, sentiment, and offers edit/delete actions.
  - *Insights* – aggregates recent entries into a pandas `DataFrame` for Plotly visualisations (mood trends, sentiment vs. mood, factor frequencies).

- **`database.py`** – Thin wrapper around an encrypted SQLite (`sqlcipher`) database.
  - Uses **SQLAlchemy** (`create_engine`) with a custom `creator` that returns an encrypted connection from `initialize_db.open_encrypted_db`.
  - Provides CRUD operations (`add_entry`, `update_entry`, `delete_entry`, `get_entries`) returning plain Python structures (list of dicts). No pandas dependency for data retrieval.

- **`initialize_db.py`** – Creates the `entries` table (full schema) if the DB does not exist, or runs migrations via `migrate_db.py` when columns are missing. The schema is defined in `EXPECTED_COLUMNS` and `CREATE_TABLE_SQL`.

- **`migrate_db.py`** – Safely adds new columns (`ai_insight`, `weather_data`) without data loss.

- **`ai_services.py`** – Wraps the Ollama LLM (`dolphin3:latest`) via LangChain. Provides:
  - `generate_daily_quote()`
  - `analyze_entry(content, mood, factors)` → short therapeutic insight.

- **`weather_service.py`** – Calls WeatherAPI.com (using the key/ZIP from `.streamlit/secrets.toml`) and returns a dict with `temperature`, `description`, and `humidity`.

- **`requirements.txt`** – Lists runtime dependencies:
  ```
  streamlit
  langchain
  pandas
  plotly
  python-dotenv
  pysqlcipher3
  sqlalchemy
  textblob
  ```

## Application Flow (summary)

1. **Startup** – `app.py` creates a `ReflectionDB` instance, which ensures the encrypted DB exists and matches the expected schema.
2. **Daily Quote** – `AIService.generate_daily_quote` runs once per session and is cached in `st.session_state`.
3. **New Entry** – UI collects mood/factors/content, obtains an AI insight, then stores the entry (including optional weather data) via `ReflectionDB.add_entry`.
4. **Past Entries** – `ReflectionDB.get_entries` returns a list of dicts; UI renders each entry with sentiment (via TextBlob), AI insight, and weather data.
5. **Insights** – Recent entries are fetched, turned into a pandas `DataFrame`, and visualised with Plotly (mood over time, sentiment vs. mood, factor frequencies).

## Configuration

- **Streamlit secrets** – Create `.streamlit/secrets.toml`:
  ```toml
  [weather]
  openweather_api_key = "your_weatherapi_key"
  zip_code = "your_zip_code"
  ```

- **LLM provider** – Currently only Ollama is supported; the model `dolphin3:latest` is used via `langchain_ollama`.

## Development Tips (concise)

- When adding new columns to the `entries` table, update `EXPECTED_COLUMNS` in `initialize_db.py`; the migration script will handle existing databases.
- Keep UI code in `app.py` lightweight; place business logic in the service modules (`ai_services`, `weather_service`, `database`).
- For new pages, follow the existing sidebar‑button pattern and add a corresponding function that updates `st.session_state.page`.
- The `get_entries` method now returns a plain list of dictionaries; pandas is only needed for the analytics page.

---

*Generated by Claude Code.*